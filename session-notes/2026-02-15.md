# Session Notes â€” Saturday, February 15, 2026

## Summary
Big session: (1) Premium PhotoDetailPanel, (2) AGPL-3.0 license, (3) Inline sticker reaction menu, (4) Music link cards â€” full implementation with play-on-card, embedded players, platform differentiation, and creative UI polish.

---

## Premium PhotoDetailPanel (from previous session)
- Replaced browser `prompt()` caption editor with a full glassmorphic detail panel
- Violet theme, ambient orb, polaroid CSS frame, GSAP entrance/exit, parallax on grab
- Owner mode: editable caption textarea + save/delete buttons
- Visitor mode: read-only caption display
- Removed photo emoji + "Photo" header text â€” let the photo be the star
- Committed as `e0a226e`

---

## AGPL-3.0 License
- Switched from MIT to AGPL-3.0 to protect IP while staying open source
- Confirmed Signal-Server uses AGPL-3.0 as precedent
- Created LICENSE file with official GNU AGPL-3.0 text
- Updated README.md license section with explanation
- Committed as `1ef47ff`

---

## Inline Sticker Reaction Menu
- Dedicated animated emoji button on every canvas object for visitors
- Random-direction slide-out (left/right/up/down) with glass pill bar
- 8 emoji options fan out with staggered bounce, individual hover feedback
- Click â†’ elastic bounce â†’ Convex mutation directly from canvas (no DOM popup)
- Committed as `3d3face`

---

## Music Link Cards (NEW â€” this session)

### Music Object on Canvas
- Dark rounded card (320x110) with play button | album art | title + artist + platform label
- oEmbed metadata fetching: Spotify, YouTube, YouTube Music, Apple Music
- Platform-colored accent (Spotify green, YouTube red, Apple Music pink)
- Thumbnail loaded via `HTMLImageElement` + `img.decode()` (Convex storage URLs are extensionless)
- Trash can delete icon (top-right, owner only) drawn with PixiJS Graphics

### Play-on-Card
- Tap music card â†’ plays music directly (no popups, no modals)
- Play button toggles to animated equalizer bars (GSAP `repeat: -1, yoyo: true`) with platform-colored glow
- Hidden iframe for YouTube Music (autoplay works silently)
- Visible YouTube video embed floats at bottom-center of screen

### Morph Embeds (Spotify & Apple Music)
- Tap play â†’ PixiJS card hides â†’ official embedded player appears at card's exact position
- Iframe tracks pan/zoom via PixiJS ticker (pauses during drag to avoid fighting)
- Draggable wrapper with grip handle bar â€” user can reposition the embed
- Drag syncs the underlying PixiJS object position + persists to Convex on release
- Stop playback â†’ embed disappears, card reappears at new position

### Platform Differentiation
- YouTube Music links (`music.youtube.com`) detected separately from regular YouTube
- Separate regex in `validators.ts` (checked before YouTube regex to avoid false match)
- Cards show "YouTube Music" vs "YouTube" labels
- YouTube Music = hidden audio-only, YouTube = visible video embed

### Add Music Modal Polish
- Removed "Add Music" heading â€” "MUSIC LINK" label + close button on same row
- Official platform SVG icons (Spotify, YouTube, YouTube Music, Apple Music) replace colored dots
- **Breathing glow**: "MUSIC LINK" text-shadow pulses (1.5s sine wave, yoyo infinite)
- **Platform-reactive ambient glow**: preview a link â†’ orb + label + border shift to brand color
- **Flowing gradient border**: conic gradient with `@property --border-angle` rotates around modal (4s loop)
- All three effects shift together when platform is recognized

### Text Size Bump
- Music card: title 15â†’18, artist 12â†’14, platform 10â†’12
- Beacon card: title 18â†’22 (line-height 24â†’28), time 14â†’16, from/location/expired 13â†’15

### Global Escape Key
- Single `keydown` listener in `+page.svelte` closes topmost open modal/menu
- Handles all modals: inline editor, add music, create beacon, create canvas, photo/beacon/note detail panels, sticker picker, friend code, friends list, canvas switcher
- Also stops music playback if nothing else is open
- SSR-safe: `window.addEventListener` only in `onMount`, guarded `removeEventListener` in `onDestroy`

### CSP Updates
- `frame-src` whitelisted: `open.spotify.com`, `embed.music.apple.com`, `www.youtube.com`

---

## Files Changed

| File | Change |
|------|--------|
| `src/convex/music.ts` | NEW â€” oEmbed metadata fetching (Spotify, YouTube, Apple Music), `createMusic` mutation |
| `src/convex/validators.ts` | Music URL validation, YouTube Music regex, length constants |
| `src/convex/schema.ts` | Added `music` type to canvasObjects discriminated union |
| `src/lib/canvas/objects/MusicObject.ts` | NEW â€” dark card with play/eq/glow, thumbnail loading, delete button, drag/tap/long-press |
| `src/lib/canvas/objects/BeaconObject.ts` | Font size bumps (title 22, time 16, secondary 15) |
| `src/lib/canvas/CanvasRenderer.ts` | `setMusicPlaying()`, `getMusicObjectRect()`, `setMusicObjectVisible()`, `moveMusicObject()`, `onMusicDeleted` callback |
| `src/lib/components/AddMusicModal.svelte` | NEW â€” glassmorphic modal with breathing glow, flowing gradient border, platform-reactive color shift |
| `src/lib/components/MusicDetailPanel.svelte` | NEW (unused) â€” was original detail panel, replaced by play-on-card approach |
| `src/lib/components/CanvasToolbar.svelte` | Added Music button |
| `src/routes/+page.svelte` | Music playback (morph/hidden/floating), draggable morph wrapper, global Escape handler |
| `src/hooks.server.ts` | CSP: whitelisted Spotify/Apple Music/YouTube iframe sources |

---

## Architecture Decisions
- Play-on-card over floating player â€” music should feel embedded in the canvas, not pull you out
- Morph embed for Spotify/Apple Music â€” iframe replaces card visually, tracks pan/zoom, draggable
- Hidden iframe for YouTube Music (autoplay works), visible embed for YouTube (video worth seeing)
- Drag handle needed because cross-origin iframe captures pointer events
- Global Escape handler in `+page.svelte` (not per-component) â€” single source of truth for modal stack

---

## Session 2 â€” Bug Fixes, Performance, and Canvas Overlay Styling

### Emoji Reaction Menu Bug Fix
- Menu collapsed before user could select an emoji â€” `pointerout` fires on parent when cursor moves to child elements (PixiJS event model matches DOM `mouseout`)
- Fixed with debounced collapse: `scheduleCollapse()` (100ms timer) + `cancelCollapse()` on child `pointerover`
- Cursor hops from trigger to emoji options without collapsing

### Convex Query Performance
- `getAccessibleCanvases` warned at 861ms (max 1s) â€” N friend canvas queries each used `.filter()` post-scan
- Added compound index `by_owner_type` on `["ownerId", "type"]` to canvases table
- Updated friend canvas queries to use compound index â€” eliminates in-memory filtering

### PhotoDetailPanel Save Button
- "Save Caption" button was hidden until text changed â€” confusing UX
- Now always visible; dimmed (35% opacity + disabled) when no changes, full violet when modified

### Canvas Overlay Styling (NEW)
- Owner can choose dot matrix or line grid overlay for their canvas
- Persisted per-canvas in Convex (`overlayMode` field on canvases table)
- `updateOverlayMode` mutation (owner-only, auth + RBAC checked)

#### CanvasRenderer Overlay
- `overlayLayer` Container in world (between parchment fill and objects)
- `setOverlayMode()` swaps Graphics children inside the persistent container
- Dots: 2.5px radius circles at 50px grid intervals, `0x9a8570` at 35% alpha
- Lines: 1px strokes at 50px grid intervals, `0x9a8570` at 25% alpha
- 50px margin from canvas edges

#### Canvas Style Picker (`CanvasStylePicker.svelte`)
- Glassmorphic button in bottom-left corner (owner-only)
- Click â†’ popover with 3 SVG icon options (None / Dots / Lines)
- Active option highlighted in warm brown (`#BFA98A`)
- GSAP entrance (scale pop-in) and exit animations
- **Hover preview**: hovering an option temporarily applies the overlay on the canvas
- Cursor leaves popover â†’ reverts to committed mode
- Click â†’ commits to Convex and persists

---

## Files Changed (Session 2)

| File | Change |
|------|--------|
| `src/convex/schema.ts` | Added `overlayMode` to canvases, `by_owner_type` compound index |
| `src/convex/canvases.ts` | Added `updateOverlayMode` mutation |
| `src/convex/access.ts` | Friend canvas queries use `by_owner_type` compound index |
| `src/lib/canvas/CanvasRenderer.ts` | `overlayLayer` container, `setOverlayMode()`, emoji menu debounce fix |
| `src/lib/components/CanvasStylePicker.svelte` | NEW â€” bottom-left overlay picker with hover preview |
| `src/lib/components/PhotoDetailPanel.svelte` | Save button always visible (dimmed when no changes) |
| `src/routes/+page.svelte` | Overlay state, picker wiring, `changeOverlayMode()` + preview callback |

---

## Architecture Decisions (Session 2)
- Overlay Container pattern: persistent Container at correct z-position, swap Graphics children inside (avoids PixiJS v8 `Graphics.clear()` quirks)
- Debounced collapse for hover menus: 100ms timer prevents parentâ†’child `pointerout` from closing menus prematurely
- Compound index over post-filter: `by_owner_type` eliminates `.filter()` scan for friend canvas lookups
- Hover preview via separate `onpreview` callback â€” visual-only, no Convex mutation until click commits

---

## Session 3 â€” Glassmorphic Toolbar Dropdowns

### Motivation
All toolbar menus (Friends, Friend Code, Canvas Switcher) used to take over the center of the screen as modal overlays with full-screen backdrops. Redesigned them to slide out directly from their toolbar buttons â€” matching the CanvasStylePicker's glassmorphic energy.

### Design Pattern (from CanvasStylePicker)
Every dropdown follows the same self-contained architecture:
- Owns its trigger button + popover + open/close state
- GSAP entrance: `back.out(2)`, scale 0.6â†’1, 0.25s
- GSAP exit: `power2.in`, scale 1â†’0.6, 0.15s
- Click-outside: `document.addEventListener('pointerdown', ...)` in `onMount`
- Escape key: self-handled with `e.stopPropagation()`
- Glassmorphic: `rgba(15, 14, 26, 0.82)`, `backdrop-filter: blur(24px)`

### FriendsList Dropdown
- Modal â†’ self-contained dropdown anchored to people-group icon
- Right-aligned popover (`top-full right-0 mt-2`), transform origin `top right`
- Amber notification dot on trigger when pending friend requests exist
- Compact 288px panel with scrollable content
- Keeps all Convex queries + accept/decline mutations

### CanvasSwitcher Dropdown
- Centered overlay â†’ self-contained dropdown anchored to canvas name button
- Left-aligned popover, transform origin `top left`
- Chevron rotates 180Â° on open (GSAP animated)
- Canvas list with active amber highlight, emoji icons, role badges
- Select or "New shared canvas" auto-closes dropdown

### FriendCodeModal Dropdown
- Full-screen modal â†’ self-contained dropdown anchored to `+` person icon
- Right-aligned popover, 280px panel
- Monospace friend code display with Copy button
- "Add a friend" input with Enter-to-submit
- Clears status message each time dropdown opens
- Keeps backfill logic for pre-Layer 3 users

### Mutual Exclusion (Free)
Click-outside handlers naturally close one dropdown when another's trigger is clicked â€” no coordination code needed.

### Architecture Shift
- `+page.svelte` no longer manages modal state for these three components
- Removed `showFriendsList`, `showCanvasSwitcher`, `showFriendCode` state variables
- Removed corresponding imports, template blocks, and Escape handler lines
- Toolbar passes data props instead of callbacks: `activeCanvasId`, `canvases`, `friendCode`
- Each dropdown is fully autonomous â€” the page doesn't know or care if they're open

---

## Files Changed (Session 3)

| File | Change |
|------|--------|
| `src/lib/components/FriendsList.svelte` | Rewrite: modal â†’ self-contained dropdown with trigger, GSAP, click-outside, Escape |
| `src/lib/components/CanvasSwitcher.svelte` | Rewrite: modal â†’ self-contained dropdown with trigger, chevron animation |
| `src/lib/components/FriendCodeModal.svelte` | Rewrite: modal â†’ self-contained dropdown with trigger, compact code/input layout |
| `src/lib/components/CanvasToolbar.svelte` | Embeds all 3 dropdown components, removes callback props, adds data props |
| `src/routes/+page.svelte` | Removes 3 state vars, 3 imports, 3 template blocks, 3 Escape handler lines |

---

## Architecture Decisions (Session 3)
- Self-contained dropdowns over page-managed modals: each component owns its full lifecycle (CanvasStylePicker pattern)
- Data props over callbacks: toolbar receives canvas/friend data and passes it through, rather than firing open/close callbacks
- Escape key handled per-component with `e.stopPropagation()` â€” prevents global handler from double-firing
- Notification dot on friends trigger â€” subtle amber indicator when pending requests exist (UX improvement now that list is behind a button)

## Session 4 â€” Performance Audit: Redundancy Cleanup & Efficiency Pass

### Motivation
After a big UI/UX day (music cards, overlay styling, glassmorphic dropdowns), ran a thorough performance audit across three axes: PixiJS rendering, Svelte+Convex backend, and bundle/config. Codebase is solid â€” no dead code, no unused deps, good security headers. But found 10 real wins in reducing redundant work, preventing leaks, and parallelizing queries.

### Backend: Parallelize `areFriends()`
- `areFriends()` ran 2 sequential DB queries (forward + reverse friendship check) â€” called on every canvas load via `objects.getByCanvas`
- Wrapped both in `Promise.all()` â€” cuts friendship check latency roughly in half
- Other callers (e.g. `getFriends`) already used `Promise.all` â€” this was the last holdout

### Shared TextStyle Constants (NEW: `textStyles.ts`)
- 5+ files independently created identical `TextStyle` objects with the same Satoshi font family
- Worst offender: `CanvasRenderer.ts` created a new `TextStyle` per remote cursor
- Created `FONT_FAMILY` string constant + `CURSOR_LABEL_STYLE` shared instance
- Updated all 5 object files to use `FONT_FAMILY` â€” single source of truth

### TextBlock RAF Leak Fix
- `scheduleHeightCheck()` fired up to 5 `requestAnimationFrame` calls without storing IDs
- If object destroyed mid-measurement, callbacks fired on dead containers
- Added `pendingRAF` tracking â€” cancelled in `destroy()`, cancelled-and-restarted on new schedule

### TextBlock Double-Redraw Elimination
- `updateText()` cleared + redrew background immediately, then `scheduleHeightCheck()` redrew it 1-5 more times
- Removed the immediate redraw â€” `scheduleHeightCheck()` handles everything, including a final sync when height stabilizes

### O(1) Object Lookups in `+page.svelte`
- 4+ `.find()` calls scanned the full `canvasObjects.data` array on every tap callback
- Added `$derived` Map: `new Map(canvasObjects.data?.map(o => [o._id, o]))`
- Replaced all `.find()` with `.get()` â€” O(1) instead of O(n)

### Polymorphic Destroy in CanvasRenderer
- 4 `instanceof` checks per object removal, but all types have `destroy()`
- Replaced with single `obj.destroy()` call â€” all union members guarantee the method

### Single GSAP Timeline for Stagger Entrance
- Two separate `gsap.to()` calls (scale + alpha) tracked independently in an array
- Replaced with single `gsap.timeline()` â€” atomic control, cleaner kill on canvas switch

### Reuse Response Dots Graphics (BeaconObject)
- `updateResponseDots()` destroyed + recreated Graphics every sync
- Now keeps the Graphics instance, uses `.clear()` + redraw â€” avoids GC churn

### EQ Tween Double-Start Guard (MusicObject)
- `setPlaying(true)` called twice rapidly could orphan infinite-repeat tweens
- Added `gsap.killTweensOf(bar.scale)` for each EQ bar before starting new tweens

---

## Files Changed (Session 4)

| File | Change |
|------|--------|
| `src/convex/friendships.ts` | `Promise.all` in `areFriends()` |
| `src/lib/canvas/textStyles.ts` | NEW â€” `FONT_FAMILY` + `CURSOR_LABEL_STYLE` shared constants |
| `src/lib/canvas/CanvasRenderer.ts` | Shared cursor style, polymorphic destroy, Timeline stagger |
| `src/lib/canvas/objects/TextBlock.ts` | RAF tracking + cancel, double-redraw elimination, `FONT_FAMILY` |
| `src/lib/canvas/objects/BeaconObject.ts` | Reuse response dots Graphics, `FONT_FAMILY` |
| `src/lib/canvas/objects/MusicObject.ts` | EQ tween kill guard, `FONT_FAMILY` |
| `src/lib/canvas/objects/PhotoObject.ts` | `FONT_FAMILY` constant |
| `src/routes/+page.svelte` | `$derived` Map for O(1) object lookups |

---

## Architecture Decisions (Session 4)
- Shared constants over duplicated literals: single `FONT_FAMILY` string, single `CURSOR_LABEL_STYLE` instance
- RAF tracking pattern: store ID in `pendingRAF`, cancel on destroy or re-schedule
- Let async measurement own the redraw: `scheduleHeightCheck()` is the single authority for background redraws after text changes
- `$derived` Map for lookup-heavy reactive data: computed once per data change, O(1) per access

---

## Session 5 â€” Pre-Deployment Security Audit

### Motivation
Third full security audit before deployment. Three parallel scans covered: (1) auth/CSP/env config, (2) all Convex mutations/queries for RBAC gaps, (3) client-side/WebRTC/dependencies. Codebase was already well-hardened from two prior passes â€” found 5 real fixes and 2 CSP hardening items.

### Fix 1: `checkCanvasAccess` on `getSignals` (signaling.ts)
- Query returned WebRTC signals without verifying canvas access
- User could subscribe to signals on a canvas they shouldn't see (leaks ICE candidate IP info)
- Added access check with `return []` on failure (graceful, matches `getViewers` pattern)

### Fix 2: `checkCanvasAccess` on `leaveCanvas` (presence.ts)
- Inconsistency: `joinCanvas` and `heartbeat` checked access, `leaveCanvas` didn't
- Added access check wrapped in try/catch (called on page unload where auth token may be gone)

### Fix 3: `checkCanvasAccess` on `consumeSignal` (signaling.ts)
- Defense-in-depth: user could only delete their own signals, but should verify they still have canvas access
- Added access check in try/catch â€” silent return on failure (stale signal cron cleans up)

### Fix 4: Rate limit friend requests (friendships.ts)
- No limit on `sendRequest` â€” user could spam every friend code they discover
- Added 20 pending requests per hour cap using existing `by_requester_status` compound index + `createdAt` post-filter

### Fix 5: Rate limit canvas object creation (objects.ts)
- No limit on objects per canvas â€” malicious user could spam-create hundreds, degrading performance
- Added 200 objects per canvas cap using existing `by_canvas` index

### Fix 6-7: CSP hardening (hooks.server.ts)
- Added `base-uri 'self'` â€” prevents `<base>` tag injection
- Added `form-action 'self'` â€” prevents form submissions to external domains
- Added `frame-ancestors 'none'` â€” CSP equivalent of `X-Frame-Options: DENY` (modern browsers prioritize CSP)

### What We Audited and Found Secure
- All other mutations: auth + RBAC checked across objects, photos, beacons, stickers, responses, music, canvases, access
- Input validation: comprehensive bounds on positions, sizes, string lengths, enums, file types, URLs
- Existing rate limits: direct beacons (10/hour), stickers (5/user/object), beacon recipients (50 max)
- WebRTC: signal payload capped (10KB), sequential processing, ICE buffering, deterministic initiator
- File upload: server-side MIME validation, 5MB size cap
- XSS: PixiJS HTMLText uses SVG foreignObject (no script execution), music URLs regex-validated
- No hardcoded secrets, `.env` in `.gitignore`, TypeScript strict mode

---

## Files Changed (Session 5)

| File | Change |
|------|--------|
| `src/convex/signaling.ts` | `checkCanvasAccess` on `getSignals` + `consumeSignal` |
| `src/convex/presence.ts` | `checkCanvasAccess` on `leaveCanvas` (try/catch for teardown) |
| `src/convex/friendships.ts` | Rate limit `sendRequest` (20/hour) |
| `src/convex/objects.ts` | Rate limit `create` (200 per canvas) |
| `src/hooks.server.ts` | CSP: `base-uri`, `form-action`, `frame-ancestors` |

---

## Session 6 â€” Rebrand to Orbyt + Business Model + Charity Research

### Rebrand: Astrophage â†’ Orbyt
- Platform renamed to **Orbyt**
- Domain secured: **orbyt.life**
- README fully updated: title, all references, Lexicon schemas (`com.orbyt.*`), link to orbyt.life
- Not yet deployed â€” landing page in progress

### AI-Assisted Beacons (Planned)
- Upgrade beacon creation with Claude Opus 4.6 integration
- Natural language: users describe what they want to do, AI suggests activities based on location, interests, and time
- Helps friends who want to hang out but don't know what to do â€” the beacon becomes a planning assistant
- Added to README tech stack and feature list

### Business Model: Donation-Based (Wikipedia/Signal Model)
- **No ads, no data sales, no attention exploitation â€” ever**
- Voluntary donations: monthly recurring or one-time, any amount
- Surplus beyond operating costs goes to charities and organizations

#### Precedent Research
- **Wikipedia (Wikimedia Foundation)**: $208.6M revenue (FY 2024-25), $189.5M from donations, avg $11/donor. Millions of small donors = independence.
- **Signal Foundation**: ~$38M/year operating costs ($14M servers, $19M staff). Funded by donations + Brian Acton's $105M 0% loan (due 2068). Runs at a net loss â€” cautionary tale.
- **Mastodon**: 545K EUR in donations (2023), launched in-app donation feature July 2025. Much smaller scale but growing.
- **Key insight**: Recurring monthly donors retain at 78-83% vs 38-45% for one-time. Start with low suggested amount ($3-5/month).

#### Orbyt Cost Advantage
Convex serverless backend = dramatically lower infra costs than Signal/Wikipedia:
- Early stage (<10K users): ~$100-650/month total
- At scale (50K+ users): ~$1K-10K/month
- No encrypted message routing overhead â€” just canvas state sync

### Charity Research: Three Focus Areas

#### 1. Protecting People Affected by AI
- **Authors Guild** â€” advocacy for writers against unauthorized AI training
- **SAG-AFTRA** â€” 160K+ performers, led 2023 AI protections strike
- **Concept Art Association** â€” visual artists in entertainment fighting AI displacement
- **Human Artistry Campaign** â€” coalition of 40+ orgs advocating for artist consent/licensing
- **Fairly Trained** â€” certifies AI developers who license training data ethically
- **Algorithmic Justice League (AJL)** â€” exposed racial/gender bias in facial recognition
- **EFF** â€” digital rights, AI privacy, surveillance, free expression (founded 1990)
- **EPIC** â€” AI regulation, transparency, private rights of action
- **DAIR Institute** (Timnit Gebru) â€” AI research rooted in marginalized communities
- **AI Now Institute** â€” social implications of AI, concentration of power in tech

#### 2. AI for Good
- **Climate Change AI** â€” nonprofit catalyzing ML for climate solutions, 600+ papers, 60+ countries
- **Open Climate Fix** â€” halved UK solar forecasting errors, fully open source
- **Wild Me (Wildbook)** â€” AI-powered wildlife identification, 188K+ individual animals tracked
- **Khan Academy (Khanmigo)** â€” AI tutoring that augments human teachers, 165M users

#### 3. Digital Rights & Public Policy
- **Center for AI and Digital Policy (CAIDP)** â€” AI governance, UN statements, human rights
- **Partnership on AI** â€” 126 partners across 16 countries, equal nonprofit/industry board
- **Center for AI Safety** â€” reducing societal-scale AI risks
- **Center for Democracy and Technology (CDT)** â€” AI policy from a civil liberties lens (since 1994)

### Open Collective Evaluation
Researched [Open Collective](https://opencollective.com/) as a transparency platform:
- **What it does**: public budget page, every transaction visible, recurring donations, expense management
- **Costs**: Platform is free. Fiscal host fees 5-10% + Stripe ~2.9%. Total 8-13% of donations.
- **Pros**: instant setup, built-in trust signal, radical transparency, fiscal hosting available (no LLC needed)
- **Cons**: OCF (main non-software fiscal host) dissolved end of 2024 â€” cautionary tale. Fee stacking. Donation page lives on their domain, not yours. Platform dependency.
- **DIY alternative**: Stripe direct = ~2.9% fees only, full control, but need to build own transparency dashboard
- **Recommendation**: Start on Open Collective to prove the model, build trust, and get instant transparency. Migrate to Stripe-based system later if fees become significant.
- Added to README: evaluating Open Collective for transparent financial reporting

### Files Changed (Session 6)

| File | Change |
|------|--------|
| `README.md` | Full rebrand (Astrophage â†’ Orbyt), orbyt.life link, Business Model section, Music features, updated Security/Rate limits, Claude Opus 4.6 in tech stack, updated Project Status |
| `session-notes/2026-02-15.md` | Session 6 notes: rebrand, business model research, charity research, Open Collective evaluation |

---

## Session 7 â€” Landing Page: Canvas IS the Landing Page

### The Vision
No traditional auth page. Unauthenticated visitors land directly on the PixiJS canvas â€” deep space, parallax stars, parchment surface, draggable showcase objects. Auth lives in a toolbar dropdown. After signing in, a cinematic pulse erupts and the canvas transitions to the user's personal space. Zero page navigation.

### AuthCardObject â€” Manifesto Card
- 620px wide glassmorphic manifesto card at canvas center
- Dark background (0x0f0e1a, 0.92 alpha), amber glow layers, rounded corners
- Text layout: "ORBYT" (72px bold) â†’ "Your attention is sacred." (30px amber tagline) â†’ divider â†’ "No feeds. No algorithms. No likes." / "No infinite scroll. No dopamine traps." (22px) â†’ "A canvas for your people." / "Real plans. Real presence." (24px) â†’ "Reclaim your time." / "Show up. Be present. Live." (32px bold amber) â†’ divider â†’ CTA
- 14 floating amber particles drift behind the card
- Entrance choreography: GSAP timeline â€” card materializes (scale 0â†’1 with back.out), glow fades in, text lines cascade with staggered slide-up+fade (0.1s apart), dividers draw from center
- Continuous life: glow breathes (2.5s sine yoyo), card floats (4s sine Â±8px), CTA pulses, manifesto lines shimmer
- `dissolve()` method for auth transition, full `killAllTweens()` cleanup

### LandingAuthCard + AuthDropdown
- Auth forms moved from full-screen `AuthModal` into toolbar dropdown (`AuthDropdown.svelte`)
- `LandingAuthCard.svelte` â€” DOM overlay positioned over the PixiJS auth card via `worldToScreen()` ticker
- Sign in / sign up form with username + password, mode toggle
- On success: dispatches callback â†’ triggers cinematic transition
- `CanvasToolbar` gains `showAccount` prop â€” hides friend code / friends / sign out during landing, shows auth dropdown instead

### Landing Page Layout (CanvasRenderer.enterLandingMode)
- **Top-left**: Notes showcase â€” "âœ¨ Welcome to Orbyt", "âœï¸ Rich Text", "ðŸŽ¬ Movie Watchlist", "ðŸŽ¨ Your Canvas", "ðŸŒŸ Movie Night Picks"
- **Top-right**: Beacons showcase â€” "Friday Hangout", "Park Run", "Game Night" (direct beacon) + "ðŸ”¥ Beacons" explainer
- **Bottom-left**: Photos showcase â€” 3 demo Polaroids + "ðŸ“¸ Photos" explainer
- **Bottom-right**: Music showcase â€” Redbone, Electric Feel, Best Part + "ðŸŽµ Music" explainer
- **Center**: AuthCardObject manifesto at (1190, 720)
- Dot matrix overlay enabled by default

### LandingTransition â€” Cinematic Auth Pulse
- `runTransition(renderer, epicenterX, epicenterY, landingObjects)` â†’ Promise
- 5 massive concentric pulse rings erupt from auth card epicenter (GSAP scale 0.1â†’20, alpha 0.8â†’0, staggered 150ms)
- Color burst flash (amber circle, scale 0â†’8, alpha 0.6â†’0)
- Star field intensifies (all layer alphas Ã—1.8 for 800ms via `StarField.intensify()`)
- Showcase objects animate out (scaleâ†’0, alphaâ†’0, staggered 80ms)
- 131 lines, clean async/await

### +page.svelte â€” Landing Mode Lifecycle
- `landingMode` state (starts `true`)
- On mount: if not authenticated â†’ `renderer.enterLandingMode()`, dots overlay
- If already authenticated â†’ skip landing (`landingMode = false`)
- `$effect` watches `currentUser.isAuthenticated` + `landingMode` â†’ triggers `handleAuthTransition()`
- `handleAuthTransition()`: `renderer.exitLandingMode()` (cinematic pulse), then sets `landingMode = false` so existing effects load user's canvas
- `AuthModal` replaced with toolbar-integrated `AuthDropdown`

### 3D Tactile Pan/Zoom (PanZoom.ts)
- Subtle depth effect during canvas drag: slight scale bump (1.012Ã—) on grab, micro-tilt following velocity direction (max Â±1.5Â°)
- GSAP lerp for tilt follow (0.12) and settle (0.08)
- Release: spring back to zero tilt + base scale
- Lock/unlock resets all 3D state so inline editing isn't affected

### StarField.intensify()
- New method: temporarily boosts all star layer alphas Ã—1.8 via GSAP
- Yoyo back after peak â€” used during landing transition for dramatic star flash

### TextBlock HTMLText Bug Fixes
- **scheduleHeightCheck early exit**: Old code exited after 2 frames when height "stabilized" at MIN_HEIGHT before HTMLText measured. Fixed: require 3 consecutive identical frames (`settled` counter) + 500ms setTimeout safety net.
- **Tailwind box-sizing conflict**: Tailwind's `* { box-sizing: border-box }` applies when PixiJS measures HTMLText (SVG attached to DOM body), but rendering uses isolated data URL (content-box default). With padding:40 + max-width:wordWrapWidth, border-box shrinks measurement by 80px â†’ right-side text clipping. Fixed: `box-sizing: content-box` in cssOverrides, padding reduced to 4.
- **overflow-wrap**: `body { overflow-wrap: break-word }` in cssOverrides does nothing (CSS nesting inside `div { }` matches `div body { }` â€” no body in foreignObject). Changed to plain property.
- **Title fontSize mismatch**: Constructor 28px vs `updateTitle()` 22px â€” fixed to 28.

### Font & Object Size Increases
- TextBlock: body 18â†’26, h1 28â†’38, h2 24â†’30, h3 22â†’28, line-height 28â†’36, title 22â†’28
- InlineNoteEditor: body 1.125â†’1.375rem, h1 1.875â†’2.375, h2 1.5â†’1.875, h3 1.375â†’1.75, title 1.25â†’1.75rem
- Cursor label: 12â†’16px
- AddMusicModal: input text 0.95â†’1.1rem, preview text bumped proportionally

---

## Session 8 â€” AI-Assisted Beacons (Joe's terminal)

### Convex AI Action (`src/convex/ai.ts`)
- New Convex `action` calling Anthropic Messages API (Claude Opus 4.6)
- Input: natural language prompt + time of day + day of week + friend count
- Output: 3 structured suggestions (activity, location, description, timeHint, durationHint, emoji)
- System prompt: hangout idea generator â€” interprets vibe, suggests real-world in-person activities
- Group context: adapts suggestions based on whether it's a canvas-wide beacon vs 1 friend vs N friends
- Strips markdown code fences, validates JSON array shape, validates all field types

### CreateBeaconModal AI Integration
- "Inspire me" input row with text field + Send button
- Natural language: "I wanna do something chill outside" â†’ 3 animated suggestion cards
- Suggestion cards: emoji bounce, staggered entrance (back.out), 3D rotateX reveal
- Click card â†’ selection burst animation (scale + glow), other cards fade, form auto-fills (title, description, location, time hints)
- Loading state: shimmer wave on input row
- GSAP-animated "AI âœ¨" badge with breathing glow
- Error handling with retry affordance

---

## Files Changed (Sessions 7 & 8)

| File | Change |
|------|--------|
| `src/lib/canvas/objects/AuthCardObject.ts` | NEW â€” 620px manifesto card with GSAP entrance, breathing glow, particles, dissolve |
| `src/lib/canvas/LandingTransition.ts` | NEW â€” cinematic pulse rings, color burst, star intensify, staggered object exit |
| `src/lib/components/LandingAuthCard.svelte` | NEW â€” DOM overlay auth form over PixiJS card, worldToScreen tracking |
| `src/lib/components/AuthDropdown.svelte` | NEW â€” toolbar-integrated sign in/up dropdown |
| `src/convex/ai.ts` | NEW â€” Convex action calling Anthropic API for beacon suggestions |
| `src/lib/canvas/CanvasRenderer.ts` | enterLandingMode (showcase objects with emojis), exitLandingMode, authCardObject lifecycle |
| `src/lib/canvas/StarField.ts` | `intensify()` method for transition drama |
| `src/lib/canvas/interactions/PanZoom.ts` | 3D tactile pan/zoom (scale bump + velocity tilt) |
| `src/lib/canvas/objects/TextBlock.ts` | box-sizing fix, scheduleHeightCheck settled counter, font size bumps |
| `src/lib/canvas/objects/BeaconObject.ts` | Font size adjustments |
| `src/lib/canvas/objects/MusicObject.ts` | Font size adjustments |
| `src/lib/canvas/objects/PhotoObject.ts` | Font size adjustments |
| `src/lib/canvas/textStyles.ts` | Cursor label size 12â†’16 |
| `src/lib/components/CanvasToolbar.svelte` | `showAccount` prop, AuthDropdown integration |
| `src/lib/components/CreateBeaconModal.svelte` | AI suggestion input, animated cards, auto-fill |
| `src/lib/components/AddMusicModal.svelte` | Font size bumps |
| `src/lib/components/InlineNoteEditor.svelte` | Font size bumps |
| `src/routes/+page.svelte` | Landing mode lifecycle, auth transition, AuthModal replaced |
| `src/convex/_generated/api.d.ts` | Auto-generated types for new `ai` module |

---

## Architecture Decisions (Sessions 7 & 8)
- Canvas IS the landing page: no separate route, no page navigation â€” auth transition is a PixiJS animation
- Auth in toolbar dropdown (not modal): consistent with glassmorphic dropdown pattern, less intrusive than full-screen overlay
- Manifesto card as PixiJS object (not DOM): draggable, animated, lives in the world â€” consistent with everything-on-canvas philosophy
- AI action in Convex (not client): API key stays server-side, response validated before returning to client
- Natural language â†’ structured data: Claude interprets vibe and returns typed JSON suggestions for form auto-fill
- 3D tactile pan: subtle (1.2% scale, 1.5Â° tilt) â€” adds physicality without being disorienting
- box-sizing: content-box in HTMLText cssOverrides: permanent fix for Tailwind border-box vs PixiJS measurement mismatch

---

## Status
- Music link cards: **complete**
- Canvas overlay styling: **complete**
- Glassmorphic toolbar dropdowns: **complete**
- Performance audit: **complete** (10 targeted fixes across 8 files)
- Security audit: **complete** (5 fixes + 2 CSP hardening across 5 files)
- Rebrand to Orbyt: **complete** (README, domain secured)
- Business model + charity research: **complete**
- Landing page: **complete** (canvas-as-landing, manifesto card, cinematic transition, showcase objects)
- AI-assisted beacons: **complete** (Convex action, suggestion cards, auto-fill)
- 3D tactile pan/zoom: **complete**
- TextBlock rendering fixes: **complete** (box-sizing, height measurement, font sizes)
- Next: Rive animations, deployment to orbyt.life, mobile app (Friendship Health dashboard)
