# Session Notes — Friday, February 14, 2026

## Summary
Three major upgrades today: (1) Natural language beacon form with chrono-node, (2) CreateBeaconModal bungee-cord parallax + quickTo fix, (3) Living Beacon Object — halftone dot display inspired by ASCII/dither art CodePen, with ripple emanation, cascading heartbeat, signal dot antenna, and layered glow.

---

## Natural Language Beacon Form (session 1)

### The Sentence Pattern
Replaced boxed labeled inputs with an inline sentence that flows like natural speech:

```
Let's [pickup basketball___] at [the park___]
[in 30 min___] for [2 hours___]
-> Today, 4:30 PM - 6:30 PM

with [everyone on canvas]

              [+ Add details]

          [ Broadcast Beacon ]
```

Each `[___]` is a borderless inline input with only a bottom underline that glows orange (canvas mode) or teal (direct mode) on focus. Static words ("Let's", "at", "for", "with") are muted white text.

### Time Parsing with chrono-node
- **"When" field** — `chrono-node` with `forwardDate: true` handles natural language: "now", "in 30 min", "at 5pm", "tomorrow at 3", "friday at noon"
- **"Duration" field** — regex-first approach for common patterns ("2 hours", "1.5 hr", "30 min", "1h30m", "2h", "1 day"), chrono-node fallback for "until 6pm", "until midnight"
- **Live preview** — reactive `$effect` recomputes on every keystroke, shows resolved range like "Today, 4:30 PM - 6:30 PM" with colored glow
- **Parse failure** — gentle hint text ("Try 'in 30 min' or 'at 5pm'") instead of error styling
- **Safe defaults** — empty when = now, empty duration = +2 hours. Convex server still validates

### State Changes
- **Removed**: `title`, `locationAddress`, `startTime`, `endTime` (old datetime-local strings), `getDefaultStartTime()`, `getDefaultEndTime()`, `formatDatetimeLocal()`
- **Added**: `whatText`, `whereText`, `whenText`, `durationText` (sentence inputs), `showDetails` (description toggle), `parsedStart`/`parsedEnd` (Date | null), `timePreview`/`parseError` (display strings)
- **Renamed**: `formFields` ref -> `sentenceBlock` (animation code updated)

---

## CreateBeaconModal — Parallax & Animation Fixes (session 2)

### Bungee cord grab-and-pull
- Grabbable header area: mouse drag applies parallax offset to the modal content
- Elastic snap-back on release via GSAP tween

### quickTo console warning fix
- **Bug**: "x not eligible for reset" / "y not eligible for reset" warnings flooding console during parallax drag
- **Cause**: `snapBack()` used `gsap.to(header, { overwrite: 'auto' })` which killed quickTo's internal tweens. When mouse moved again, stale quickTo functions warned about dead tweens
- **Fix**: Added `onComplete: initParallax` to the header snap-back tween — re-creates fresh quickTo functions after elastic animation finishes

---

## Living Beacon Object (session 2-3)

### Halftone Dot Display
Inspired by [CodePen Dither/ASCII Effect Pro](https://codepen.io/sabosugi/full/bNegbmy) — the "Halftone (Luma>Size)" mode where circles vary in SIZE based on signal intensity.

- Dark card background (`0x0a0a14`) with animated dot grid
- Each dot is a **Sprite** sharing a single 32x32 white circle texture (created once via Canvas 2D)
- Dot **scale** varies with signal wave intensity — big dots where waves are strong, tiny specks in quiet areas
- Concentric signal waves radiate outward from card center
- Center hotspot always brighter (signal source)
- Gentle breathing animation keeps everything alive
- Masked to card shape with rounded corners
- All sprites tinted with beacon color (orange for canvas, teal for direct)

### Square card
- Changed from dynamic-height rectangle to 260x260 square
- More room for the halftone animation to breathe
- Text: title + time at top, location pinned to bottom

### Text sizing
- Title: 15px → 18px, lineHeight 24
- Time: 12px → 14px
- Location: 11px → 13px, moved to bottom of card
- From username: 11px → 13px, above location line

### Performance iterations
1. **Custom GLSL shader** (first attempt) — WebGL errors, PixiJS v8 filter uniform binding incompatible
2. **Graphics.clear() + redraw** (second attempt) — worked visually but rAF violations (140ms+ per frame rebuilding geometry)
3. **Alpha-bucketed Graphics** (third attempt) — reduced fill calls from 300 to 5, still too slow
4. **Sprite-based** (final) — sprites created once, only scale/alpha updated per frame. No geometry rebuild. All sprites batched into 1 draw call via shared texture

### Living beacon layers (back to front)
1. **rippleLayer** — expanding circle Graphics (spawn every 2800ms, fade over 3.5s)
2. **ambientGlow** — large soft circle (warm radiance beyond card)
3. **outerGlow** — rounded rect, wide diffuse glow
4. **glowRing** — rounded rect, tight inner pulse ring
5. **cardBg** — dark rounded rect base
6. **halftoneContainer** — sprite grid, masked to card shape
7. **signalDot** — white/color circle at top center ("antenna")
8. **Text content** — title, pin icon, time, location, from label
9. **Response dots / Stickers** — unchanged

### Cascading heartbeat pulse
GSAP timeline (`repeat: -1, repeatDelay: 1.8s`):
- Signal dot flash (scale 1→1.5→1, alpha 0.7→1→0.7)
- Inner glow ring (alpha + scale bump)
- Outer glow (alpha + scale bump)
- Ambient glow (alpha pulse)
- Card micro-scale (1→1.006→1)

### New file
- `src/lib/canvas/objects/BeaconSignalFilter.ts` — custom GLSL fragment shader (unused, kept for reference — halftone replaced it with sprites)

---

## Performance Audit (session 4)

### Optimizations Applied
1. **Removed stencil mask** from halftone container — eliminated extra render pass for 144 sprites
2. **Increased cell size** 16→22px — reduced sprite count from 289 to 144 per beacon
3. **Throttled halftone** to every 5th frame (~12fps) — wave effect is slow enough that 12fps looks smooth
4. **Simplified wave math** — replaced `Math.pow()` with multiplication, pre-computed shared values outside dot loop
5. **`cacheAsTexture()`** on halftone container — PixiJS draws 1 cached texture quad instead of 144 sprites on non-update frames
6. **`boundsArea`** on halftone + beacon containers — prevents recursive bounds measurement of all children
7. **GSAP `lagSmoothing(500, 33)`** — prevents frame-drop cascades where GSAP tries to catch up
8. **Removed CSS `filter: blur(40px)`** from CreateBeaconModal ambient orb — replaced with pre-softened 500px radial gradient (blur was costing 50-100ms per frame during parallax)
9. **Fixed quickTo warnings** — null all 6 quickTo refs at top of `snapBack()` so mousemove doesn't call stale functions

### Chrome DevTools Performance Trace Results
Recorded 148.6 seconds of canvas interaction:

| Metric | Value |
|--------|-------|
| Total animation frames | 1,968 |
| Median frame time | **0.1ms** |
| p95 frame time | 0.5ms |
| p99 frame time | 0.8ms |
| Frames >16ms | 2 (out of 1,968) |
| Frames >50ms | 2 |
| `_tick` avg duration | 0.3ms |

**Verdict: No performance problem.** The app runs at 60fps with sub-1ms frame times. The console violations (145ms) were caused by **one-time image decoding** (`Decode Image` 40-43ms) happening on the main thread when photos first load — not the canvas animation pipeline. The third long task (123ms) was DevTools itself starting the profiler (`CpuProfiler::StartProfiling`).

---

## Files Changed

| File | Change |
|------|--------|
| `src/lib/components/CreateBeaconModal.svelte` | Natural language form + quickTo fix + blur removal |
| `src/lib/canvas/objects/BeaconObject.ts` | Full rewrite — halftone sprites, cacheAsTexture, boundsArea, square card, bigger text, living pulse |
| `src/lib/canvas/objects/BeaconSignalFilter.ts` | New — custom GLSL shader (unused, reference) |
| `src/lib/canvas/gsapInit.ts` | Added lagSmoothing frame-drop protection |

---

## Status
- Living Beacon Object with halftone display: complete
- Natural language beacon form: complete
- quickTo parallax fix: complete
- Performance audit: **complete — app runs at 60fps, no issues**
- Next: music link cards, Rive animations + polish, demo prep
