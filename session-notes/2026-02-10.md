# Session Notes — Tuesday, February 10, 2026

## Summary
Built Astrophage from the ground up in a single day — Layer 1 (canvas foundation) and Layer 2 (backend, auth, persistence). Went from empty SvelteKit scaffold to a working app with real-time sync.

---

## Layer 1: Canvas Foundation

### Project Setup
- Created SvelteKit project with TypeScript + Tailwind v4
- Installed PixiJS v8, Motion, tween.js
- Configured Vite with `@tailwindcss/vite` plugin
- Set up `app.css` with `@import "tailwindcss"` and full-screen body reset

### Canvas Engine
- **CanvasRenderer** (`src/lib/canvas/CanvasRenderer.ts`): Main class that owns the PixiJS Application and world Container. 3000x2000 bounded canvas with warm off-white background (`0xf5f0eb`). Async `init()` pattern required by PixiJS v8.
- **PanZoom** (`src/lib/canvas/interactions/PanZoom.ts`): Click-drag panning with momentum/inertia. Scroll-wheel zoom targeting pointer position. Rubber-band edge resistance. Spring-back animation.
- **DragDrop** (`src/lib/canvas/interactions/DragDrop.ts`): `makeDraggable()` function for any PixiJS Container. Uses `stopPropagation()` to prevent pan/drag conflict.
- **TextBlock** (`src/lib/canvas/objects/TextBlock.ts`): Sticky-note style objects with rounded rectangle backgrounds and word-wrapped text.

### Key Architecture Decisions
- World container pattern: pan/zoom moves the world, not individual objects
- Event conflict resolution via stopPropagation
- No separate auth pages — auth is a modal overlay on the canvas
- Canvas bounded intentionally (not infinite) to create creative constraint

---

## Layer 2: Backend + Auth + Persistence

### Plan
8 sequential steps to add the backbone:

1. **Install Convex + Bootstrap Connection** — Get Convex running and talking to SvelteKit
2. **Define Database Schema** — users, canvases, canvasObjects tables with UUID-based IDs
3. **Set Up Better Auth** — Username/password auth with Convex adapter
4. **Build Auth Abstraction Layer** — Isolate Better Auth behind `$lib/auth`
5. **Build Auth Modal** — Login/signup overlay on canvas
6. **User Registration Pipeline** — UUID generation, personal canvas auto-creation
7. **Canvas Object Persistence** — TextBlocks saved to/loaded from Convex, real-time sync
8. **Canvas Toolbar + Polish** — Add Note button, sign out, username display

### Key Decisions
- **Better Auth** chosen over Convex Auth (beta/React-only) and Clerk (no SvelteKit support)
- Email placeholder (`username@astrophage.local`) generated internally — users never see it
- UUIDs as canonical user IDs (not Convex `_id`) for AT Protocol portability
- Auth abstraction: only `authService.ts` imports Better Auth directly
- Convex functions live in `src/convex/` (not root) — SvelteKit can't import outside `src/`

### What Was Built

**Step 1: Convex Setup**
- [x] Installed `convex` + `convex-svelte`
- [x] Created `convex.json` pointing to `src/convex/`
- [x] Added `$convex` alias to `svelte.config.js`
- [x] Updated `+layout.svelte` with Convex + auth client initialization

**Step 2: Database Schema**
- [x] Created `src/convex/schema.ts` with `users`, `canvases`, `canvasObjects` tables
- [x] UUID-based `ownerId`/`creatorId` for AT Protocol portability
- [x] Proper indexes: `by_uuid`, `by_username`, `by_auth_account`, `by_owner`, `by_canvas`

**Step 3: Better Auth Setup**
- [x] Installed `@convex-dev/better-auth`, `better-auth@1.4.9`, `@mmailaender/convex-better-auth-svelte`
- [x] Created Convex auth files: `convex.config.ts`, `auth.config.ts`, `auth.ts`, `http.ts`
- [x] Created client auth: `src/lib/auth-client.ts` with username + convex plugins
- [x] Created SvelteKit API route and server hooks

**Step 4: Auth Abstraction Layer**
- [x] Created `src/lib/auth/types.ts`, `authService.ts`, `currentUser.svelte.ts`, `index.ts`
- [x] Only `authService.ts` imports Better Auth directly

**Step 5: Auth Modal**
- [x] Created `AuthModal.svelte` — sign up / sign in toggle, Motion animated, blurred backdrop

**Step 6: User Registration Pipeline**
- [x] Created `src/convex/users.ts` — `createUser` (UUID + personal canvas), user queries
- [x] Created `src/convex/canvases.ts` — `getPersonalCanvas` query

**Step 7: Canvas Object Persistence**
- [x] Created `src/convex/objects.ts` — CRUD for canvas objects
- [x] Modified `DragDrop.ts` — added `onDragEnd` callback
- [x] Modified `TextBlock.ts` — added `objectId` + persistence options
- [x] Modified `CanvasRenderer.ts` — removed demos, added `syncObjects()` reconciliation
- [x] Wired reactive query chain in `+page.svelte`: user → canvas → objects → PixiJS

**Step 8: Canvas Toolbar**
- [x] Created `CanvasToolbar.svelte` — floating bar with Add Note, sign out, username

### Bugs Fixed During Integration
1. **`process.env` in Convex runtime** — Need `@types/node` for TypeScript; Convex runtime supports `process.env` for env vars set via `npx convex env set`
2. **`getCurrentUser` throwing on unauthenticated** — `getAuthUser()` throws when no token. Wrapped in try/catch, return `null`
3. **Auth user ID field mismatch** — Better Auth Convex user has `_id` not `id`. Fixed lookup to use `._id`
4. **Auth modal flash on refresh** — Two-phase approach: `$effect` catches auth instantly; 1500ms timeout fallback for logged-out users

### Convex Setup
- [x] Ran `npx convex dev` — created project "astrophage" on Convex cloud
- [x] Set `BETTER_AUTH_SECRET` and `SITE_URL` env vars
- [x] First user account created: joemiddie13

---

## End-to-End Verification
- [x] Canvas renders with auth modal on top (logged out)
- [x] Sign up with username + password → modal disappears, toolbar shows
- [x] Sign out → modal returns
- [x] Sign back in → canvas and toolbar restored
- [x] Add Note → TextBlock appears on canvas
- [x] Drag note → position persists after refresh
- [x] Real-time sync works across tabs
- [x] Convex dashboard shows users, canvases, canvasObjects tables populated

## Status
- **Layer 1**: Complete
- **Layer 2**: Complete and verified
- **Next**: Layer 3 — Beacons, beacon responses, sticker reactions
