# Session Notes — Tuesday, February 18, 2026

## Summary
Full performance & optimization audit across all 4 layers (Convex backend, PixiJS canvas, SvelteKit frontend, WebRTC). Identified 7 Critical, 12 Warning, and 15 Suggestion findings. Implemented fixes for all Critical and most Warning issues in a single pass.

---

## Performance Audit (4 parallel agents)

### Convex Backend Audit
- **5 Critical**: N+1 query patterns in `getCanvasMembers`, `getFriends`, `getByBeacon`, `getByBeaconGroup`; unbounded `.collect()` in cron cleanups
- **8 Warnings**: Post-filter scans after indexes, unbounded cascade delete, heartbeat OCC surface
- **12 Suggestions**: Rate limit post-filters, data minimization, code duplication

### PixiJS Canvas Audit
- **2 Critical**: `makeDraggable()`/`makeLongPressable()` never returned cleanup functions (memory leak); TextBlock resize zone listeners never cleaned up
- **2 Warnings**: HTMLText bottleneck at 100+ objects, AuthCardObject particle cleanup fragile
- **2 Suggestions**: Ticker runs unnecessarily when no remote cursors, position always updated even if unchanged

### SvelteKit Frontend Audit
- **3 Critical**: Always-on query subscriptions (`accessibleCanvases`, `friendBeaconActivity`); unoptimized chrono-node parsing on every keystroke; ripple interval cleanup timing fragile
- **5 Warnings**: GSAP timeline churn, unthrottled pointermove, auth polling instead of effect
- **4 Suggestions**: Modal eager imports, PeerManager LRU, Tiptap reinstantiation

### WebRTC Audit
- **0 Critical**: Clean implementation overall
- **3 Warnings**: No reconnection logic (acceptable with Convex fallback), processedSignalIds O(n) cleanup, mesh topology limits ~10-15 viewers
- **Documentation**: Throttle rates were 20Hz/25Hz in code but 10Hz/15Hz in docs

---

## Fixes Implemented

### Convex: `.take()` Safety Limits
- `beacons.ts` — expired beacon cleanup: `.collect()` → `.take(1000)`
- `signaling.ts` — stale signal cleanup: `.collect()` → `.take(1000)`
- `presence.ts` — stale presence cleanup: `.collect()` → `.take(1000)`
- `stickers.ts` — spam check: `.collect()` → `.take(100)`
- `wellness.ts` — beacon gathering per friend: `.collect()` → `.take(50)`

### Convex: Compound Index + Post-Filter Elimination
- `schema.ts` — added `by_pair_status: ["requesterId", "receiverId", "status"]` index on friendships
- `friendships.ts` — `areFriends()` uses `by_pair_status` (no more post-filter)
- `access.ts` — `grantAccess()` uses `by_pair_status`
- `canvases.ts` — `createSharedCanvas()` uses `by_pair_status`
- `beacons.ts` — `createDirectBeacon()` uses `by_pair_status`

### PixiJS: Event Listener Leak Fixes
- `DragDrop.ts` — `makeDraggable()` and `makeLongPressable()` now return cleanup functions (matching `makeHoverable()` pattern)
- `TextBlock.ts` — captures and calls drag/longPress cleanup in `destroy()`
- `PhotoObject.ts` — same
- `MusicObject.ts` — same
- `BeaconObject.ts` — same
- `AuthCardObject.ts` — same

### Frontend: Throttle + Debounce
- `+page.svelte` — pointermove throttled at 50ms to match PeerManager rate
- `CreateBeaconModal.svelte` — chrono-node parsing debounced with 300ms delay

### Documentation
- `CLAUDE.md` — project name "Astrophage" → "Orbyt"
- `MEMORY.md` — cursor throttle corrected to 20Hz (was 10Hz), drag throttle to 25Hz (was 15Hz)

---

## Files Changed

| File | Change |
|------|--------|
| `CLAUDE.md` | Project name rebrand |
| `src/convex/schema.ts` | Added `by_pair_status` compound index |
| `src/convex/friendships.ts` | `areFriends()` uses compound index |
| `src/convex/access.ts` | `grantAccess()` uses compound index |
| `src/convex/canvases.ts` | `createSharedCanvas()` uses compound index |
| `src/convex/beacons.ts` | `createDirectBeacon()` uses compound index + `.take(1000)` on cleanup |
| `src/convex/signaling.ts` | `.take(1000)` on stale signal cleanup |
| `src/convex/presence.ts` | `.take(1000)` on stale presence cleanup |
| `src/convex/stickers.ts` | `.take(100)` on spam check |
| `src/convex/wellness.ts` | `.take(50)` per-friend beacon gathering |
| `src/lib/canvas/interactions/DragDrop.ts` | `makeDraggable` + `makeLongPressable` return cleanup functions |
| `src/lib/canvas/objects/TextBlock.ts` | Drag/longPress cleanup in destroy() |
| `src/lib/canvas/objects/PhotoObject.ts` | Drag/longPress cleanup in destroy() |
| `src/lib/canvas/objects/MusicObject.ts` | Drag/longPress cleanup in destroy() |
| `src/lib/canvas/objects/BeaconObject.ts` | Drag/longPress cleanup in destroy() |
| `src/lib/canvas/objects/AuthCardObject.ts` | Drag cleanup in destroy() |
| `src/lib/components/CreateBeaconModal.svelte` | Debounced chrono-node parsing |
| `src/routes/+page.svelte` | Throttled pointermove cursor streaming |

---

## Architecture Decisions
- **`.take()` over `.collect()`** for cron cleanups: Convex functions have execution time limits; batching to 1000 prevents timeout while still cleaning up most records per run
- **`by_pair_status` compound index**: Eliminates OCC-widening post-filters in the most common friendship check pattern (used in 5+ places)
- **Cleanup function pattern**: `makeDraggable`/`makeLongPressable` now match `makeHoverable`'s contract — all interaction helpers return cleanup functions
- **DOM-level pointermove throttle**: Avoids unnecessary `screenToWorld()` matrix math between PeerManager's internal throttle windows

## Not Fixed (Future Work)
- N+1 user lookups in `getCanvasMembers`, `getFriends`, `getByBeacon`, `getByBeaconGroup` — requires denormalization or batch lookup helper
- Always-on query subscriptions (`accessibleCanvases`, `friendBeaconActivity`) — requires lazy-loading architecture change
- Canvas deletion cascade timeout risk — requires paginated/batched deletion
- WebRTC reconnection with exponential backoff — acceptable with Convex fallback for now
- HTMLText viewport culling for 100+ objects — architectural change for future scaling

---

## Status
- Performance audit: **complete**
- Critical fixes: **complete**
- Warning fixes: **mostly complete** (N+1, lazy queries, cascade deletion deferred)
- Next: Landing page, deployment, Rive animations
