# Session Notes — Tuesday, February 11, 2026

## Summary
Layer 3 build day — the social layer. Built friend codes, shared canvases, beacons, responses, stickers, expiration, and direct beacons. Also fixed canvas zoom/pan and updated the visual theme.

---

## Layer 3: The Social Layer (Steps 1–7 complete)

### Step 1: Friend Codes & Connections
- Added `friendCode` field (optional, for backcompat with existing user joemiddle13)
- 10-char alphanumeric, no ambiguous chars (0/O/1/l/I), collision-checked
- `ensureFriendCode` mutation backfills pre-Layer 3 users on first access
- `friendships` table: requesterId, receiverId, status (pending/accepted/declined)
- Auto-accept if both users send each other codes
- New files: `src/convex/friendships.ts`, `FriendCodeModal.svelte`, `FriendsList.svelte`
- Exported `getAuthenticatedUser` from `users.ts` as shared helper

### Step 2: Shared Canvases & Access Control
- `canvasAccess` table: canvasId, userId (UUID), role (owner/member/viewer)
- `checkCanvasAccess()` in objects.ts — role-based gatekeeper (RBAC)
- `objects.ts` refactored from owner-only to role-based (viewer: read, member: add/move, owner: full)
- `createSharedCanvas` mutation validates friendships before granting access
- Canvas switcher: reactive query swaps — changing `activeCanvasId` auto-unsubs/resubs Convex queries
- New files: `src/convex/access.ts`, `CanvasSwitcher.svelte`, `CreateCanvasModal.svelte`, `CanvasMembersPanel.svelte`

### Step 3: Beacon Objects on Canvas
- Beacons are `canvasObjects` with `type: "beacon"` — discriminated union in schema
- `BeaconObject.ts`: PixiJS visual with amber card, pin icon, title, time, location
- Pulse animation: tween.js glow ring oscillates alpha/scale with sine easing, yoyo repeat
- Pop-in animation: scale 0→1 with `Easing.Back.Out` (overshoot bounce)
- tween.js integrated into PixiJS ticker: `TWEEN.update()` runs every frame
- Content union: `v.union(textblockContent, beaconContent)` — one table, two shapes
- New files: `BeaconObject.ts`, `CreateBeaconModal.svelte`, `BeaconDetailPanel.svelte`

### Step 4: Beacon Responses
- `beaconResponses` table: beaconId, userId, status (joining/interested/declined)
- Upsert pattern: responding again replaces your previous response
- Attendee list shows names grouped by status — no numeric counts (design principle)
- Response dots on beacon card: small colored circles (green=going, amber=interested)
- New file: `src/convex/responses.ts`

### Step 5: Sticker Reactions
- `stickerReactions` table: objectId, userId, stickerType, position (relative to parent)
- 8 emoji stickers: heart, fire, laugh, wave, star, 100, thumbs-up, eyes
- `StickerReaction.ts`: PixiJS Text with elastic pop-in (scale 0→1.2→1)
- Long-press detection in `DragDrop.ts`: 500ms hold without 5px movement → callback
- Stickers are children of parent object's Container — move with the parent automatically
- New files: `src/convex/stickers.ts`, `StickerReaction.ts`, `StickerPicker.svelte`

### Step 6: Beacon Expiration & Cleanup
- `crons.ts`: Convex cron runs `cleanupExpired` every 15 minutes
- Cleanup deletes expired beacons + associated responses + stickers
- `internalMutation` — only callable by system, not clients
- Expired beacons: alpha 0.3, pulse stops, "Expired" label
- New files: `src/convex/beacons.ts`, `src/convex/crons.ts`

### Step 7: Direct Beacons
- `createDirectBeacon` mutation: validates recipients are friends, generates `directBeaconGroupId`
- Places beacon copies on each recipient's personal canvas + creator's own canvas
- Teal visual for direct beacons (vs orange for canvas beacons), "From [username]" label
- Response aggregation: `getByBeaconGroup` query dedupes by userId across all copies
- Visibility toggle in CreateBeaconModal: "Everyone on canvas" vs "Direct to friends"

---

## Bug Fixes & Polish

### CSP blocking Vite dev server
- `hooks.server.ts`: CSP `script-src 'self'` blocks Vite's inline HMR scripts
- Fix: detect `NODE_ENV !== "production"` and add `'unsafe-inline' 'unsafe-eval'` in dev only
- Also added `ws://localhost:* http://localhost:*` to `connect-src` for dev

### Canvas zoom/pan fixes
- **Min zoom lock**: Dynamic `getMinZoom()` calculates minimum zoom so canvas fills 75% of viewport
- **Auto-center on load**: `centerCanvas()` sets initial zoom + centers the canvas
- **Inverted bounds fix**: When canvas is smaller than viewport, `minX > maxX` — swapped with `Math.min/max` so spring-back doesn't fight the user's drag

### Visual theme update
- Background: `0x0a0a1a` (deep space dark)
- Canvas surface: `0xe8e0d4` (warm parchment, darker than before)
- Canvas has rounded corners (16px radius) + subtle border
- Border color: `0xc4b5a5`

### Auth speed
- Reduced fallback timeout from 1500ms to 800ms for logged-out users
- Friend code backfill `$effect` fires on login for pre-Layer 3 users

---

## CanvasToolbar Update
- Added: canvas name/switcher button, "+ Beacon" button, friend code icon, friends list icon
- Props expanded: `canvasName`, `onCreateBeacon`, `onFriends`, `onFriendsList`, `onCanvasSwitcher`

## +page.svelte Overhaul
- `activeCanvasId` / `activeCanvasName` state for canvas switching
- Reactive query swap: changing active canvas auto-resubs all Convex queries
- 7 modal states wired up: friend code, friends list, canvas switcher, create canvas, create beacon, beacon detail, sticker picker
- Sticker placement: long-press → picker → `addSticker` mutation with random offset position

---

## Schema (final state)
6 tables total:
- `users` (+ friendCode, by_friend_code index)
- `canvases` (unchanged)
- `canvasAccess` (new — RBAC)
- `friendships` (new)
- `canvasObjects` (expanded: beacon type, content union, expiresAt)
- `beaconResponses` (new)
- `stickerReactions` (new)

## Files Created
- `src/convex/friendships.ts`, `access.ts`, `beacons.ts`, `responses.ts`, `stickers.ts`, `crons.ts`
- `src/lib/canvas/objects/BeaconObject.ts`, `StickerReaction.ts`
- `src/lib/components/FriendCodeModal.svelte`, `FriendsList.svelte`, `CanvasSwitcher.svelte`, `CreateCanvasModal.svelte`, `CanvasMembersPanel.svelte`, `CreateBeaconModal.svelte`, `BeaconDetailPanel.svelte`, `StickerPicker.svelte`

## Files Modified
- `schema.ts`, `users.ts`, `objects.ts`, `canvases.ts`, `auth types.ts`, `currentUser.svelte.ts`
- `CanvasRenderer.ts`, `TextBlock.ts`, `DragDrop.ts`, `PanZoom.ts`
- `CanvasToolbar.svelte`, `+page.svelte`, `hooks.server.ts`

---

## Status
- Layer 3 Steps 1–7: complete and deployed to Convex
- Step 8 (Rive animations + polish): pending
- Next: continue testing features, then commit + Rive polish pass
