# Session Notes — Tuesday, February 11, 2026

## Summary
Layer 3 build day — the social layer. Built friend codes, shared canvases, beacons, responses, stickers, expiration, and direct beacons. Also fixed canvas zoom/pan and updated the visual theme.

---

## Layer 3: The Social Layer (Steps 1–7 complete)

### Step 1: Friend Codes & Connections
- Added `friendCode` field (optional, for backcompat with existing user joemiddle13)
- 10-char alphanumeric, no ambiguous chars (0/O/1/l/I), collision-checked
- `ensureFriendCode` mutation backfills pre-Layer 3 users on first access
- `friendships` table: requesterId, receiverId, status (pending/accepted/declined)
- Auto-accept if both users send each other codes
- New files: `src/convex/friendships.ts`, `FriendCodeModal.svelte`, `FriendsList.svelte`
- Exported `getAuthenticatedUser` from `users.ts` as shared helper

### Step 2: Shared Canvases & Access Control
- `canvasAccess` table: canvasId, userId (UUID), role (owner/member/viewer)
- `checkCanvasAccess()` in objects.ts — role-based gatekeeper (RBAC)
- `objects.ts` refactored from owner-only to role-based (viewer: read, member: add/move, owner: full)
- `createSharedCanvas` mutation validates friendships before granting access
- Canvas switcher: reactive query swaps — changing `activeCanvasId` auto-unsubs/resubs Convex queries
- New files: `src/convex/access.ts`, `CanvasSwitcher.svelte`, `CreateCanvasModal.svelte`, `CanvasMembersPanel.svelte`

### Step 3: Beacon Objects on Canvas
- Beacons are `canvasObjects` with `type: "beacon"` — discriminated union in schema
- `BeaconObject.ts`: PixiJS visual with amber card, pin icon, title, time, location
- Pulse animation: tween.js glow ring oscillates alpha/scale with sine easing, yoyo repeat
- Pop-in animation: scale 0→1 with `Easing.Back.Out` (overshoot bounce)
- tween.js integrated into PixiJS ticker: `TWEEN.update()` runs every frame
- Content union: `v.union(textblockContent, beaconContent)` — one table, two shapes
- New files: `BeaconObject.ts`, `CreateBeaconModal.svelte`, `BeaconDetailPanel.svelte`

### Step 4: Beacon Responses
- `beaconResponses` table: beaconId, userId, status (joining/interested/declined)
- Upsert pattern: responding again replaces your previous response
- Attendee list shows names grouped by status — no numeric counts (design principle)
- Response dots on beacon card: small colored circles (green=going, amber=interested)
- New file: `src/convex/responses.ts`

### Step 5: Sticker Reactions
- `stickerReactions` table: objectId, userId, stickerType, position (relative to parent)
- 8 emoji stickers: heart, fire, laugh, wave, star, 100, thumbs-up, eyes
- `StickerReaction.ts`: PixiJS Text with elastic pop-in (scale 0→1.2→1)
- Long-press detection in `DragDrop.ts`: 500ms hold without 5px movement → callback
- Stickers are children of parent object's Container — move with the parent automatically
- New files: `src/convex/stickers.ts`, `StickerReaction.ts`, `StickerPicker.svelte`

### Step 6: Beacon Expiration & Cleanup
- `crons.ts`: Convex cron runs `cleanupExpired` every 15 minutes
- Cleanup deletes expired beacons + associated responses + stickers
- `internalMutation` — only callable by system, not clients
- Expired beacons: alpha 0.3, pulse stops, "Expired" label
- New files: `src/convex/beacons.ts`, `src/convex/crons.ts`

### Step 7: Direct Beacons
- `createDirectBeacon` mutation: validates recipients are friends, generates `directBeaconGroupId`
- Places beacon copies on each recipient's personal canvas + creator's own canvas
- Teal visual for direct beacons (vs orange for canvas beacons), "From [username]" label
- Response aggregation: `getByBeaconGroup` query dedupes by userId across all copies
- Visibility toggle in CreateBeaconModal: "Everyone on canvas" vs "Direct to friends"

---

## Bug Fixes & Polish

### CSP blocking Vite dev server
- `hooks.server.ts`: CSP `script-src 'self'` blocks Vite's inline HMR scripts
- Fix: detect `NODE_ENV !== "production"` and add `'unsafe-inline' 'unsafe-eval'` in dev only
- Also added `ws://localhost:* http://localhost:*` to `connect-src` for dev

### Canvas zoom/pan fixes
- **Min zoom lock**: Dynamic `getMinZoom()` calculates minimum zoom so canvas fills 75% of viewport
- **Auto-center on load**: `centerCanvas()` sets initial zoom + centers the canvas
- **Inverted bounds fix**: When canvas is smaller than viewport, `minX > maxX` — swapped with `Math.min/max` so spring-back doesn't fight the user's drag

### Visual theme update
- Background: `0x0a0a1a` (deep space dark)
- Canvas surface: `0xe8e0d4` (warm parchment, darker than before)
- Canvas has rounded corners (16px radius) + subtle border
- Border color: `0xc4b5a5`

### Auth speed
- Reduced fallback timeout from 1500ms to 800ms for logged-out users
- Friend code backfill `$effect` fires on login for pre-Layer 3 users

---

## CanvasToolbar Update
- Added: canvas name/switcher button, "+ Beacon" button, friend code icon, friends list icon
- Props expanded: `canvasName`, `onCreateBeacon`, `onFriends`, `onFriendsList`, `onCanvasSwitcher`

## +page.svelte Overhaul
- `activeCanvasId` / `activeCanvasName` state for canvas switching
- Reactive query swap: changing active canvas auto-resubs all Convex queries
- 7 modal states wired up: friend code, friends list, canvas switcher, create canvas, create beacon, beacon detail, sticker picker
- Sticker placement: long-press → picker → `addSticker` mutation with random offset position

---

## Schema (final state)
6 tables total:
- `users` (+ friendCode, by_friend_code index)
- `canvases` (unchanged)
- `canvasAccess` (new — RBAC)
- `friendships` (new)
- `canvasObjects` (expanded: beacon type, content union, expiresAt)
- `beaconResponses` (new)
- `stickerReactions` (new)

## Files Created
- `src/convex/friendships.ts`, `access.ts`, `beacons.ts`, `responses.ts`, `stickers.ts`, `crons.ts`
- `src/lib/canvas/objects/BeaconObject.ts`, `StickerReaction.ts`
- `src/lib/components/FriendCodeModal.svelte`, `FriendsList.svelte`, `CanvasSwitcher.svelte`, `CreateCanvasModal.svelte`, `CanvasMembersPanel.svelte`, `CreateBeaconModal.svelte`, `BeaconDetailPanel.svelte`, `StickerPicker.svelte`

## Files Modified
- `schema.ts`, `users.ts`, `objects.ts`, `canvases.ts`, `auth types.ts`, `currentUser.svelte.ts`
- `CanvasRenderer.ts`, `TextBlock.ts`, `DragDrop.ts`, `PanZoom.ts`
- `CanvasToolbar.svelte`, `+page.svelte`, `hooks.server.ts`

---

## WebRTC Real-Time Layer

### Overview
Added peer-to-peer real-time communication via native WebRTC API. Cursor presence, smooth drag streaming, and "who's viewing" indicators. Convex stays authoritative for all persistent state — WebRTC handles only ephemeral, high-frequency data.

### Architecture
- **Hybrid model**: WebRTC data channels for cursors/drag, Convex for persistence
- **Signaling**: Via Convex `signalingMessages` table + reactive queries (no extra infra)
- **Presence**: `canvasPresence` table with 30s heartbeat, 60s stale threshold, 2min cleanup cron
- **Native API**: Uses `RTCPeerConnection` + `RTCDataChannel` directly (no simple-peer — it has Node.js dependencies incompatible with Vite/browser)
- **Deterministic initiator**: Lower UUID string creates the offer (prevents glare)
- **Graceful degradation**: WebRTC failure = Convex-only behavior (current baseline)

### Key Implementation Details
- ICE candidate buffering: Candidates are queued until remote description is set (signals arrive batched via Convex reactive queries)
- Sequential signal processing queue: Prevents race conditions when offer + ICE candidates arrive in the same tick
- Throttled sends: Cursor 10Hz (100ms), drag 15Hz (66ms)
- Remote cursors rendered in PixiJS world container (move with pan/zoom), fade after 3s, hide after 5s
- Deterministic cursor colors per userId (hash-based)
- Friend-based canvas access: `hasCanvasAccess` helper checks owner, canvasAccess table, AND friendship for personal canvases

### Bugs Fixed During Implementation
- **simple-peer incompatible with Vite**: `global is not defined`, Node.js streams externalized — replaced with native RTCPeerConnection API
- **Signaling access denied for friends**: `sendSignal` didn't account for friend-based access to personal canvases — added `hasCanvasAccess` helper using `areFriends`
- **Auth errors during page unload**: `heartbeat`/`leaveCanvas` fire when auth token is already gone — wrapped `getAuthenticatedUser` in `.catch(() => null)`
- **ARIA warnings flooding Vite**: Added `warningFilter` to `svelte.config.js` compilerOptions
- **ICE candidate race condition**: Offer + ICE candidates arrive in same batch, candidates added before `setRemoteDescription` — added ICE buffer + sequential signal queue
- **mDNS blocking same-machine testing**: Chrome hides local IPs behind `.local` mDNS hostnames — disabled via `chrome://flags` for local dev. Not an issue in production (different machines = different IPs)

### Files Created
- `src/convex/signaling.ts` — WebRTC signal relay with access control
- `src/convex/presence.ts` — Canvas presence tracking (join, heartbeat, leave, getViewers)
- `src/lib/webrtc/types.ts` — DataChannelMessage union, RemoteCursor, PeerManagerCallbacks
- `src/lib/webrtc/PeerConnection.ts` — Native RTCPeerConnection wrapper with ICE buffering
- `src/lib/webrtc/PeerManager.ts` — Multi-peer orchestrator with throttled sends
- `src/lib/webrtc/index.ts` — Barrel exports
- `src/lib/components/ViewerAvatars.svelte` — Floating pill showing who's viewing

### Files Modified
- `schema.ts` — Added `signalingMessages` + `canvasPresence` tables
- `crons.ts` — Signal cleanup (5min) + presence cleanup (2min)
- `DragDrop.ts` — Added `onDragMove` callback
- `TextBlock.ts`, `BeaconObject.ts` — Wired `onDragMove` through `makeDraggable`
- `CanvasRenderer.ts` — Remote cursors, remote drag, cursor staleness, `screenToWorld`
- `+page.svelte` — PeerManager init, presence lifecycle, signal processing, viewer discovery, cursor streaming
- `CanvasToolbar.svelte` — Green dot when WebRTC connected
- `svelte.config.js` — Warning filter for ARIA + state_referenced_locally
- `access.ts`, `friendships.ts`, `users.ts`, `objects.ts` — Access control helpers, exported `areFriends`

### Schema (final state)
8 tables total:
- `users`, `canvases`, `canvasAccess`, `friendships`, `canvasObjects`, `beaconResponses`, `stickerReactions`
- NEW: `signalingMessages`, `canvasPresence`

---

## Future Improvements
- **TURN server**: Add TURN credentials for relay fallback — handles VPN users, strict NATs, and hides peer IPs for extra privacy. VPNs that allow UDP work fine with current STUN-only setup; VPNs that block UDP will fall back to Convex-only sync. TURN with TCP fallback would cover both cases.
- **Smoothness**: Current drag/cursor updates are slightly choppy (stop-animation feel). Could add tweening/interpolation on the receiving end for smoother remote movements.
- **Step 8**: Rive animations + polish (still pending)
- **Parallax space background**: Idea from earlier session

## Status
- Layer 3 Steps 1–7: complete and deployed to Convex
- WebRTC Real-Time Layer: complete and working (tested with two browsers, same machine)
- Step 8 (Rive animations + polish): pending
